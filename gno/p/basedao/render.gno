package basedao

import (
	"std"
	"strings"

	"gno.land/p/demo/mux"
	"gno.land/p/demo/seqid"
	"gno.land/p/demo/ufmt"
	"gno.land/p/teritori/daokit"
)

const (
	HOME_PATH             = ""
	CONFIG_PATH           = "config"
	PROPOSAL_HISTORY_PATH = "history"
	MEMBER_DETAIL_PATH    = "member/{address}"
	PROPOSAL_DETAIL_PATH  = "proposal/{id}"
)

func (d *DAO) initRenderingRouter() {
	if d.RenderRouter == nil {
		d.RenderRouter = mux.NewRouter()
	}
	d.RenderRouter.HandleFunc(HOME_PATH, d.renderHomePage)
	d.RenderRouter.HandleFunc(CONFIG_PATH, d.renderConfigPage)
	d.RenderRouter.HandleFunc(PROPOSAL_HISTORY_PATH, d.renderProposalHistoryPage)
	d.RenderRouter.HandleFunc(MEMBER_DETAIL_PATH, d.renderMemberDetailPage)
	d.RenderRouter.HandleFunc(PROPOSAL_DETAIL_PATH, d.renderProposalDetailPage)
}

func (d *DAO) Render(path string) string {
	return d.RenderRouter.Render(path)
}

func (d *DAO) renderHomePage(res *mux.ResponseWriter, req *mux.Request) {
	name := d.GetProfileString(d.Realm.Addr(), "DisplayName", "DAO")
	description := d.GetProfileString(d.Realm.Addr(), "Bio", "Created with daokit")
	pkgPath := d.Realm.PkgPath()
	linkPath := getLinkPath(pkgPath)

	res.Write(ufmt.Sprintf("# %s\n\n", name))
	res.Write(ufmt.Sprintf("%s\n\n", description))
	res.Write(ufmt.Sprintf("> Realm address: %s\n\n", d.Realm.Addr()))
	res.Write(ufmt.Sprintf("Discover more about this DAO on the [configuration page ‚öôÔ∏è](%s:%s)\n\n", linkPath, CONFIG_PATH))

	res.Write(ufmt.Sprintf("## Members üë§ \n\n"))
	i := 1
	d.Members.Members.Iterate("", "", func(key string, value interface{}) bool {
		res.Write(ufmt.Sprintf("- **Member %d: [%s](%s:%s/%s)**\n\n", i, key, linkPath, "member", key))
		res.Write(ufmt.Sprintf("	- **Profile:** %s\n", d.GetProfileString(std.Address(key), "DisplayName", "Unknown")))
		res.Write(ufmt.Sprintf(" 	- **Roles:** %s\n\n", strings.Join(d.Members.GetMemberRoles(key), ", ")))
		i += 1
		return false
	})

	res.Write(ufmt.Sprintf("> You can find more information about a member by clicking on their address\n\n"))
	res.Write(ufmt.Sprintf("\n--------------------------------\n"))

	res.Write(ufmt.Sprintf("## Running Proposals üó≥Ô∏è\n\n"))
	i = 0
	d.Core.ProposalModule.Proposals.Iterate("", "", func(key string, value interface{}) bool {
		proposal := value.(*daokit.Proposal)
		if proposal.Status != daokit.ProposalStatusOpen {
			return false
		}
		id, err := seqid.FromString(key)
		if err != nil {
			panic(err)
		}
		res.Write(ufmt.Sprintf("- **Proposal %d: [%s](%s:%s/%s)**\n\n", uint64(id), proposal.Title, linkPath, "proposal", key))
		i += 1
		return false
	})
	if i == 0 {
		res.Write(ufmt.Sprintf("\t‚ö†Ô∏è There are no running proposals at the moment\n\n"))
	}

	res.Write(ufmt.Sprintf("> See the [proposal history üìú](%s:%s) for more information\n\n", linkPath, PROPOSAL_HISTORY_PATH))
	res.Write(ufmt.Sprintf("\n--------------------------------\n"))
	res.Write(ufmt.Sprintf("[Add a new proposal üó≥Ô∏è](%s$help)\n\n", linkPath))
}

func (d *DAO) renderConfigPage(res *mux.ResponseWriter, req *mux.Request) {
	name := d.GetProfileString(d.Realm.Addr(), "DisplayName", "DAO")

	res.Write(ufmt.Sprintf("# %s - Config ‚öôÔ∏è\n\n", name))
	roles := d.Members.GetRoles()
	res.Write(ufmt.Sprintf("## Roles üè∑Ô∏è\n\n"))
	for _, role := range roles {
		res.Write(ufmt.Sprintf("- %s\n\n", role))
		info := d.Members.RoleManager.RoleInfo(role)
		res.Write("  " + info.Description + "\n")
	}
	res.Write(ufmt.Sprintf("\n--------------------------------\n"))
	res.Write(ufmt.Sprintf("## Resources üì¶\n\n"))
	i := 1
	d.Core.Resources.Resources.Iterate("", "", func(key string, value interface{}) bool {
		resource := value.(*daokit.Resource)
		res.Write(ufmt.Sprintf("- **Resource #%d: %s**\n\n", i, key))
		// TODO: add doc to handler and print here
		res.Write(ufmt.Sprintf("  - **Condition:** %s\n\n", resource.Condition.Render()))
		i += 1
		return false
	})
}

func (d *DAO) renderProposalHistoryPage(res *mux.ResponseWriter, req *mux.Request) {
	name := d.GetProfileString(d.Realm.Addr(), "DisplayName", "DAO")
	pkgPath := d.Realm.PkgPath()
	linkPath := getLinkPath(pkgPath)

	res.Write(ufmt.Sprintf("# %s - Proposal History\n\n", name))
	res.Write(ufmt.Sprintf("## Proposals üó≥Ô∏è\n\n"))
	i := 1
	d.Core.ProposalModule.Proposals.Iterate("", "", func(key string, value interface{}) bool {
		proposal := value.(*daokit.Proposal)
		id, err := seqid.FromString(key)
		if err != nil {
			panic(err)
		}
		res.Write(ufmt.Sprintf("- **Proposal %d: [%s](%s:%s/%s) - %s**\n\n", uint64(id), proposal.Title, linkPath, "proposal", key, proposal.Status))
		i += 1
		return false
	})
	res.Write(ufmt.Sprintf("\n--------------------------------\n"))
	res.Write(ufmt.Sprintf("[Add a new proposal üó≥Ô∏è](%s$help)\n\n", linkPath))
}

func (d *DAO) renderMemberDetailPage(res *mux.ResponseWriter, req *mux.Request) {
	name := d.GetProfileString(d.Realm.Addr(), "DisplayName", "DAO")
	pkgPath := d.Realm.PkgPath()
	linkPath := getLinkPath(pkgPath)

	res.Write(ufmt.Sprintf("# %s - Member Detail\n\n", name))
	roles := d.Members.GetMemberRoles(req.GetVar("address"))
	displayName := d.GetProfileString(std.Address(req.GetVar("address")), "DisplayName", "Unknown")
	bio := d.GetProfileString(std.Address(req.GetVar("address")), "Bio", "No bio")
	pp := d.GetProfileString(std.Address(req.GetVar("address")), "Avatar", "")
	res.Write(ufmt.Sprintf("## Profile üë§\n\n"))
	res.Write(ufmt.Sprintf("- **Display Name:** %s\n\n", displayName))
	res.Write(ufmt.Sprintf("- **Bio:** %s\n\n", bio))
	if pp != "" {
		res.Write(ufmt.Sprintf("![Avatar](%s)\n\n", pp))
	}
	res.Write(ufmt.Sprintf("## Roles üè∑Ô∏è\n\n"))
	for _, role := range roles {
		res.Write(ufmt.Sprintf("- %s\n\n", role))
	}
	res.Write(ufmt.Sprintf("> Learn more about the roles on the [configuration page ‚öôÔ∏è](%s:%s)\n\n", linkPath, CONFIG_PATH))
}

func (d *DAO) renderProposalDetailPage(res *mux.ResponseWriter, req *mux.Request) {
	name := d.GetProfileString(d.Realm.Addr(), "DisplayName", "DAO")
	pkgPath := d.Realm.PkgPath()
	linkPath := getLinkPath(pkgPath)

	id, err := seqid.FromString(req.GetVar("id"))
	if err != nil {
		panic(err)
	}
	res.Write(ufmt.Sprintf("# %s - Proposal #%d\n\n", name, uint64(id)))
	proposal := d.Core.ProposalModule.GetProposal(uint64(id))
	res.Write(ufmt.Sprintf("## Title - %s üìú\n\n", proposal.Title))
	res.Write(ufmt.Sprintf("## Description üìù\n\n%s\n\n", proposal.Description))
	res.Write(ufmt.Sprintf("## Resource - %s üì¶\n\n", proposal.Message.Type()))
	res.Write(proposal.Message.String() + "\n\n")
	if proposal.Status == daokit.ProposalStatusOpen {
		res.Write(ufmt.Sprintf("## Status - Open üü°\n\n"))
		res.Write(ufmt.Sprintf("[Vote on this proposal üó≥Ô∏è](%s$help)\n\n", linkPath))
	} else if proposal.Status == daokit.ProposalStatusPassed {
		res.Write(ufmt.Sprintf("## Status - Passed üü¢\n\n"))
		res.Write(ufmt.Sprintf("[Execute this proposal üó≥Ô∏è](%s$help)\n\n", linkPath))
	} else if proposal.Status == daokit.ProposalStatusExecuted {
		res.Write(ufmt.Sprintf("## Status - Executed ‚úÖ\n\n"))
	} else {
		res.Write(ufmt.Sprintf("## Status - Closed üî¥\n\n"))
	}
	res.Write(ufmt.Sprintf("> proposed by %s üë§\n\n", proposal.ProposerID))

	res.Write(ufmt.Sprintf("\n--------------------------------\n"))

	res.Write(ufmt.Sprintf("## Votes üó≥Ô∏è\n\n"))
	res.Write(ufmt.Sprintf("%s\n\n", proposal.ConditionState.RenderJSON(proposal.Votes)))
}

func getLinkPath(pkgPath string) string {
	slashIdx := strings.IndexRune(pkgPath, '/')
	if slashIdx != 1 {
		return pkgPath[slashIdx:]
	}
	return ""
}
